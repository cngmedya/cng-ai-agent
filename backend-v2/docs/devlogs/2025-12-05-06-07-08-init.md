

# Devlog — GODMODE Discovery Engine
## Kapsam: Son 3 Gün (2025-12-07 / 2025-12-08 / 2025-12-09)

---

## 2025-12-07 — Roadmap Alignment & Faz 1 Son Hazırlık

### Özet
- GODMODE modülünün **gerçek roadmap kaynağı** olarak `GODMODE_ROADMAP.md` dosyasını netleştirdik.
- GitHub’daki roadmap ile önceki çıktılar arasında farklar tespit edildi; bundan sonra:
  - Her geliştirme öncesi roadmap’e bakma
  - Her geliştirme sonrası roadmap’i güncelleme
  kuralını **zorunlu** hale getirdik.
- Faz 1’in eksik görünen kısmı olan **1.G mini geliştirmeler** tekrar masaya yatırıldı:
  - Provider normalization
  - Pipeline log & job log sistemi
  - Worker stub entegrasyonu
  - Faz 1 final cleanup planı

### Teknik Noktalar
- `GODMODE_ROADMAP.md`:
  - Faz 1 tüm alt başlıklar tekrar okunup,
  - 1.G altındaki maddeler (özellikle Job Event Log System ve Worker Orchestration Stub) işaretlenmek üzere notlandı.
- GODMODE klasör ağacı teyit edildi:
  - `api/`, `service.js`, `repo.js`, `providers/`, `workers/`, `docs/`

### Sonraki Adımlar (ertesi gün için)
- 1.G alt görevlerini kod tarafında tek tek uygulamaya başlamak:
  - Job event log tablosu ve repo fonksiyonları
  - Worker stub tetikleme
  - Discovery pipeline’dan gelen upsert log’larının oturtulması
- Faz 1 tamamlandıktan sonra Faz 2’ye geçmek üzere net checklist çıkarmak.

---

## 2025-12-08 — Faz 1 Tamamlama (1.G) & Event Log Sistemi

### Özet
- GODMODE Faz 1’i **gerçekten production-ready** seviyeye taşımak için 1.G altındaki geliştirmeler yapıldı.
- Google Places canlı discovery testleri ile:
  - Job creation
  - Job run
  - Result summary
  - `potential_leads` upsert
  uçtan uca birkaç kez doğrulandı.
- **Job Event Log System** için SQLite tablo ve repo/service entegrasyonu tamamlandı.
- Data dosyası karmaşası (`data/app.sqlite` vs `src/data/app.sqlite`) tespit edilip temizlendi.

### Yapılan Teknik Çalışmalar

#### 1) GODMODE discovery job akışının sertleştirilmesi
- `service.js`:
  - `createDiscoveryJob` / `runDiscoveryJob` isim/exports tutarsızlıkları düzeltildi.
  - Job oluşturma sırasında:
    - UUID
    - `criteria` snapshot
    - initial `status=queued`
    - progress başlangıç değerleri
  - Job run:
    - `queued` → `running` → (mock/live engine) → `completed` / `failed`
  - Faz 1 için engine versiyonu net:
    - `engine_version: "v1.0.0-live"` (sonra 2. günde 1.1.0’a evrildi)

- `pipeline/discoveryPipeline.js`:
  - Google Places sonucu ile gelen lead’ler `potential_leads` tablosuna **upsert** edildi.
  - Log:
    - `[GODMODE][PIPELINE] potential_leads upsert tamamlandı. affected=<n>`

#### 2) Job Event Log System (1.G.5)

- **SQLite tablo oluşturma** (ilk başta elle, sonra kalıcı DB tarafına):
  - Tablo: `godmode_job_logs`
    - `id INTEGER PRIMARY KEY AUTOINCREMENT`
    - `job_id TEXT`
    - `event_type TEXT`
    - `payload_json TEXT`
    - `created_at TEXT`
  - Index:
    - `idx_job_logs_job_id` (job_id üzerinde)

- `repo.js`:
  - `appendJobLog(jobId, eventType, payload?)`
    - JSON payload string’lenerek DB’ye yazılıyor.
  - `getJobLogs(jobId)`
    - Belirli bir job’ın event geçmişini sıralı çekmek için helper.

- `service.js`:
  - Job lifecycle aşamalarında log çağrıları:
    - Job create → `QUEUED`
    - Run start → `RUN_START`
    - Her provider page / çağrısı → `PROVIDER_PAGE`
    - Başarılı bitiş → `COMPLETED`
    - Hatalı bitiş → `FAILED` + error payload
  - Böylece her job için “adım adım” izlenebilir bir timeline oluştu.

- DB yol karmaşası çözümü:
  - Node process’in kullandığı DB dosyası `src/data/app.sqlite` olarak netleştirildi.
  - Terminalde yapılan testlerde yanlışlıkla `data/app.sqlite`’e sorgu atıldığı ortaya çıktı.
  - Eski `data/app.sqlite` gerekiyorsa backup alındı, ardından temizlendi.
  - Son durumda tablo listesi:
    - `godmode_job_logs`, `godmode_jobs`, `godmode_job_progress`, `godmode_job_results`, `potential_leads`, `lead_*` tabloları → hepsi **src/data/app.sqlite** altında.

#### 3) Smoke Testler

- CURL ile çeşitli testler:
  - Job create:
    - `GODMODE Faz1 test job`
    - `GODMODE Faz2 pipeline test`
    - `Validation test job`
  - Job run:
    - `POST /api/godmode/jobs/:id/run`
  - Result:
    - `status: completed`
    - `result_summary.engine_version` ve lead sayıları doğrulandı.
  - `potential_leads`:
    - `SELECT name, city, google_place_id FROM potential_leads ORDER BY created_at DESC LIMIT 10;`
    - Google’daki firmaların doğru şekilde DB’de tutulduğu teyit edildi.
  - Loglar:
    - `SELECT id, job_id, event_type, created_at FROM godmode_job_logs ORDER BY id DESC LIMIT 20;`
    - Şu event zincirleri gözlemlendi: `QUEUED → RUN_START → PROVIDER_PAGE (xN) → COMPLETED`.

### Sonraki Adımlar
- Faz 1 tamamen bitmiş kabul edilerek roadmap’te:
  - 1.A–1.F + 1.G alt görevlerinin hepsi “done” olarak işaretlendi.
- Bir sonraki gün:
  - Faz 2’ye giriş: Provider Abstraction Layer + Google Places provider’ın tam normalize edilmesi.
  - `GODMODE.md` içine versiyon ve capability özeti eklemek.

---

## 2025-12-09 — Faz 2 Başlangıcı (Provider Layer & Normalization)

### Özet
- Faz 1 resmi olarak **%100 tamamlandı** ve roadmap güncellendi.
- Faz 2’ye geçiş yapıldı:
  - Provider Abstraction Layer (PAL) için temel yapı kuruldu.
  - Google Places provider v1.1.0 formatına taşındı (normalize output).
  - `providersRunner` ile multi-provider’a hazır bir runner katmanı yazıldı.
  - `service.js` içinde FAZ 2’ye uygun `result_summary` alanları ve engine_version güncellendi:
    - `engine_version: "v1.1.0-live-faz2"`
- `used_categories` / `providers_used` / `provider_errors` gibi alanlar hem summary seviyesinde hem `stats` altında tutulmaya başlandı.

### Yapılan Teknik Çalışmalar

#### 1) googlePlacesProvider.js (FAZ 2 normalization)

- Google Places text search sonuçları normalize edildi:
  - Output schema:
    - `provider: "google_places"`
    - `place_id`
    - `name`
    - `address`
    - `city`
    - `country`
    - `rating`
    - `user_ratings_total`
    - `types`
    - `business_status`
    - `location { lat, lng }`
    - `raw.reference`
  - Eksik alanlar için güvenli default’lar / null değerler.
- Fonksiyon:
  - `runGooglePlacesDiscovery(criteria)`:
    - `criteria.categories`, `minGoogleRating`, `maxResults`, `city`, `country` parametrelerini kullanarak text search çağrısı.
    - `used_categories` listesi (hangi kategori keyword’lerinin gerçekten kullanıldığı).
    - `provider_errors`: Şimdilik hata yoksa boş liste, ileride rate limit vb. durumlar için hazır.

#### 2) providersRunner.js (Provider Abstraction Layer v1)

- Yeni dosya:
  - `providers/providersRunner.js`
- Fonksiyon:
  ```js
  async function runDiscoveryProviders(criteria) {
    const leads = [];
    const providersUsed = [];
    const usedCategories = [];

    const channels = Array.isArray(criteria?.channels)
      ? criteria.channels
      : ['google_places'];

    if (channels.includes('google_places')) {
      const gp = await runGooglePlacesDiscovery(criteria);
      providersUsed.push('google_places');

      if (Array.isArray(gp.used_categories)) {
        usedCategories.push(...gp.used_categories);
      }
      if (Array.isArray(gp.leads)) {
        leads.push(...gp.leads);
      }
      // ileride: provider_errors merge edilecek
    }

    return {
      leads,
      providers_used: Array.from(new Set(providersUsed)),
      used_categories: Array.from(new Set(usedCategories)),
      // provider_errors: [] // şimdilik service tarafında set ediliyor
    };
  }

	•	Şu an sadece google_places aktif, ama yapı gereği:
	•	İleride linkedin, instagram, facebook, yelp vb. provider’lar if (channels.includes('xxx')) bloklarıyla kolayca eklenebilir.

3) service.js — Faz 2 result_summary & stats
	•	runDiscoveryJobLive Faz 2’ye göre güncellendi:
	•	Discovery çağrıları artık runDiscoveryProviders(criteria) üzerinden geçiyor.
	•	Dönen sonuçlardan:
	•	leads
	•	providers_used
	•	used_categories
	•	İleride provider_errors
toplandı.
	•	job.result_summary yeni format:
	•	engine_version: "v1.1.0-live-faz2"
	•	notes: Faz 2’nin multi-provider yapısına hazır olduğuna dair açıklama.
	•	criteria_snapshot: input criteria’nın snapshot’ı (city, country, categories, rating, vs.)
	•	providers_used: örn. ["google_places"]
	•	used_categories: şu anlık:
	•	Eğer provider runner used_categories dolu dönerse onu kullanıyor.
	•	Boş ise fallback olarak criteria.categories’den güvenli bir set üretiliyor (son testte aktif hale geldi).
	•	provider_errors: şimdilik [], ama alan hazır.
	•	stats:
	•	found_leads
	•	enriched_leads (heuristic %70)
	•	providers_used
	•	used_categories
	•	sample_leads: normalize edilmiş ilk 10 lead.
	•	Eski job’larda providers_used vb. alanların null kalması normal; önemli olan yeni job’ların doğru formatta dönmesi. Bunu birlikte curl + jq ile doğruladık.

4) used_categories fix & fallback
	•	İlk denemede used_categories boş geliyordu.
	•	İyileştirme:
	•	Runner’dan gelen değer boş ise:
	•	criteria.categories üzerinden fallback set oluşturuluyor.
	•	Yeni job testleri:
	•	criteria.categories: ["mimarlık ofisi", "güzellik merkezi"]
	•	used_categories ve stats.used_categories:
	•	Örn. ["mimarlık ofisi"] (şu anki lógica göre)
	•	Eski job’ları önemsemiyoruz; roadmap’e göre de zaten Faz 2’den sonrası için yeni format esas alınacak.

Roadmap Güncelleme Notları
	•	FAZ 2 altında:
	•	2.A – Unified provider interface → v1.1.0 için ✅ kabul edildi.
	•	2.B.1 – Google Places Provider Hardening & Normalization → ✅ tamamlandı.
	•	GODMODE_ROADMAP.md içinde bunlar “done” şeklinde işaretlendi, açıklamalar güncellendi.
	•	Dedup & freshness policy şimdilik tasarım seviyesinde roadmap’e eklendi:
	•	2.B.6 – Discovery Deduplication & Freshness Policy (Design Draft):
	•	potential_leads üzerinden unique key + freshness window konsepti
	•	Şimdilik implementation yok, sadece roadmap tasarımı.

Sonraki Adımlar
	•	Faz 2’de sıradaki hedefler:
	•	Provider health check ve rate limit/backoff katmanı (2.A devamı).
	•	İkinci ve üçüncü provider (örneğin LinkedIn / Instagram) için taslak adapter yazmak.
	•	Dedup & freshness politikasının ilk basit versiyonunu implemente etmek (en azından metrik tarafını: deduped_leads_count, skipped_as_existing_count).
	•	Tüm bunlar ilerlerken her büyük adım sonrası:
	•	GODMODE_ROADMAP.md ve
	•	Gerekirse GODMODE.md
güncel tutulacak.

Eğer istersen bu devlog’u üç ayrı dosyaya da bölebilirim:

- `2025-12-07-godmode.md`
- `2025-12-08-godmode.md`
- `2025-12-09-godmode.md`

diye; ama bence “son 3 gün” için tek dosyada toplu görmek de güzel oldu.